<!DOCTYPE html>
<html 
    lang="en-us"
    class="no-js"
>



<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="author" content="">
    <meta name="description" content="">
    
    <meta name="generator" content="Hugo 0.59.0" />
    <meta name="generation-date" content="2019-11-29 10:32:45.111097 &#43;0800 CST m=&#43;0.269994501">
    <title>nodejs之旅(6)热替换与热加载 &middot; 云亦海</title>
    <link rel="shortcut icon" href="https://gerrywp.github.io/blog/img/favicon.ico">
    <link rel="icon" href="https://gerrywp.github.io/blog/img/favicon.ico">
    
<link rel="stylesheet" href="https://gerrywp.github.io/blog/css/materialize.min.css">


<link rel="stylesheet" href="https://gerrywp.github.io/blog/css/font-awesome.min.css">


    
    <link rel="stylesheet" href="https://gerrywp.github.io/blog/css/styles/railscasts.css">



<link rel="stylesheet" href="https://gerrywp.github.io/blog/css/lightbox.css">


<link rel="stylesheet" href="https://gerrywp.github.io/blog/css/main.css">


    <script src="https://gerrywp.github.io/blog/js/modernizr-latest.js"></script>
    <script src="https://gerrywp.github.io/blog/js/lazysizes.min.js"></script>
    <script src="https://gerrywp.github.io/blog/js/ls.noscript.min.js"></script>

    <script>
        window.lazySizesConfig = window.lazySizesConfig || {};
        lazySizesConfig.addClasses = true;
        lazySizesConfig.loadMode = 2;
    </script>

    
</head>



<body class="page-colors minimum-viewport-height">
    

<nav class="main-menu menu-colors">
    <ul class="menu menu-colors no-list-float">
        <li><a href="https://gerrywp.github.io/blog/"><i class="fa fa-home fa-2x"></i></a></li>
        <li>
            <a href="#!"><i class="fa fa-bars fa-2x"></i></a>

            
            <ul class="menu flexible-width menu-colors no-list-float">
                
                
                    <li class="active">
                    
                        <a href="/blog/post/">
                            
                            <span>Posts</span>
                        </a>
                    
                    </li>
                
            </ul>
        </li>
        <li><a href="#!" data-lightbox-id="searchbox"><i class="fa fa-search fa-2x"></i></a></li>
        
            <li class="blue-grey-text" style="border-top: 1px solid;"></li>
            
        
        <li class="blue-grey-text" style="border-top: 1px solid;"></li>
        <li>
            <a href="" type="application/rss+xml" target="_blank">
                <i class="fa fa-rss fa-2x"></i>
            </a>
        </li>
    </ul>
</nav>

<div id="searchbox" class="no-display">
    <div class="valign-wrapper fill-container">
        <div class="valign large-form horizontal-center-hack">
            <form method="get" id="search" action="http://duckduckgo.com/">
    <input type="hidden" name="sites"value="https://gerrywp.github.io/blog/"/>
    <input type="hidden" name="ka" value="h"/>
    <input type="hidden" name="k7" value="#fafafa"/>
    <input type="hidden" name="kj" value="#3f3f3f"/>
    <input type="hidden" name="ky" value="#fafafa"/>
    <input type="hidden" name="kx" value="b"/>
    <input type="hidden" name="kt" value="Helvetica"/>
    <input type="text" name="q" maxlength="255" placeholder="Search"/>
    <input type="submit" value="DuckDuckGo Search" style="visibility: hidden;" />
</form>


        </div>
    </div>
</div>





    <div class="main-content">
        <div class="center-space">
            <div class="article-colors">
                
                <article>
                    <header>
                        <h1 class="article-title">nodejs之旅(6)热替换与热加载</h1>
                        <time class="date-color">Thu Aug 16, 2018</time>
                        <span class="separator">|</span>
                        
<ul class="categories">
    <li>
        <i class="fa fa-book"></i>
    </li>
    
        <li><a href="https://gerrywp.github.io/blog/categories/javascript">javascript</a></li>
    
</ul>


                        <span class="separator">|</span>
                        
<ul class="tags">
    <li>
        <i class="fa fa-tags"></i>
    </li>
    
        <li><a href="https://gerrywp.github.io/blog/tags/tag1">tag1</a></li>
    
</ul>


                    </header>

                    <hr>

                    <section>
                        
                            <p>　　在开发阶段，我们希望每次更改了代码就会响应的改变页面，这种方式在webpack里面叫做
<strong>热替换HMR</strong>(hot module replacement)!在react开发中，希望每次更改代码的时候不要刷新整个页面，而是让网页中的React组件渲染代码替换成新的代码。这种方式就叫做热加载(hot load)。在此不使用<code>webpack-dev-server</code>的<strong>hot</strong>模式，
而是在自己搭建的expressjs服务器上，实现热更新和react组件的热加载！</p>

<h3 id="代码的热替换">代码的热替换</h3>

<p>为了使用热自动加载，我们需要两个express的中间件:
1. <a href="https://www.npmjs.com/package/webpack-dev-middleware" title="点我访问">webpack-dev-middleware</a>,用于动态运行webpack生成打包后的内存文件。
2. <a href="https://www.npmjs.com/package/webpack-hot-middleware" title="点我访问">webpack-hot-middleware</a>,用于处理来自浏览器的热加载请求。</p>

<p>具体参照插件文档，插件经常更新，使用方式也不尽相同,在expressjs中使用如下：</p>

<pre><code class="language-js">var webpack = require('webpack');
var webpackConfig = require('./webpack.config');
var compiler = webpack(webpackConfig);
 
app.use(require(&quot;webpack-dev-middleware&quot;)(compiler, {
    noInfo: true, publicPath: webpackConfig.output.publicPath
}));
app.use(require(&quot;webpack-hot-middleware&quot;)(compiler));
</code></pre>

<p>其中值得注意的是<code>webpack-dev-middleware</code>使用的是webpack.config配置文件来打包文件！仅仅使用的是publicPath(与path是不同的，具体参考webpack文档)，
因为<code>webpack-dev-middleware</code>仅生成内存文件，文件路径就是<code>publicPath</code>指定的路径，因此我们的index.html的bundle.js路径要跟这个<code>publicPath</code>保持一致！</p>

<pre><code class="language-html">// index.html
&lt;script src=&quot;/bundle.js&quot; /&gt;
</code></pre>

<pre><code class="language-js">// webpack.config
entry:{
output:{
  publicPath:'/'
}
}
</code></pre>

<p>并且在webpack.config的plugins配置节配置:</p>

<pre><code class="language-js">//webpack.config
plugins:[new webpack.HotModuleReplacementPlugin()]
</code></pre>

<p>entry节点要加入:</p>

<pre><code class="language-js">entry: [
    ['webpack-hot-middleware/client', 'app.js']
]
</code></pre>

<p>至此我们的热更新已经配置完成了，此时我们修改reat组件，浏览器并不会自动刷新更新组件内容，通过提示得知
<a href="https://www.npmjs.com/package/react-hot-loader" title="点我访问">react-hot-loader</a>派上了用场！
具体的配置按照文档配置来：
1. 在<code>bable-loader</code>配置节plugins添加对<code>react-hot-loader/babel</code>插件的使用
2. 需要将自己的根组件通过hot导出！
这里有个需要注意的问题，JSX语法的问题。
ES6对于只return一个对象的函数体，ES6允许简写省去return,直接用圆括号把返回的对象包起来就行!</p>

<pre><code class="language-js">// App.js
import React from 'react'
import { hot } from 'react-hot-loader'
 
const App = () =&gt; &lt;div&gt;Hello World!&lt;/div&gt;;

export default hot(module)(App)
</code></pre>

<p>这里我就犯了一个错误，组件一定要定义成一个function类型的对象，而不能直接定义成一个object类型的对象，这样在<code>ract-hot-loader</code>会报错</p>

<pre><code class="language-js">//以下是不良好的书写习惯！直接是object变量,而非function变量
consst App= &lt;div&gt;Hello World!&lt;/div&gt;;
export {App};
//这样的代码直接在react使用是没有问题的，但是使用了`react-hot-loader`就会报错了，请注意
</code></pre>

<h3 id="原理解析">原理解析</h3>

<p>这里先从<code>webpack-dev-middleware</code>(以下简称dev中间件)说起，这个中间件做的工作其实很简单，就是根据webpack.config配置文件将模块进行打包。
作用类似于直接在命令行(command-line)输入<code>webpack</code>手动打包一样，不同点在于:
1. dev中间件可以动态配置，在服务器端启动后就进行打包，便于开发调试
2. dve中间件捕获源文件的改动自动进行打包！
3. dev中间件根据publicPath设置的路径，将bundle.js文件放在内存里。 并对比文件改动，只打包改动的文件，响应速度更快！
4. 使用<code>react-hot-loader/bable</code>对代码做支持热加载的预处理！
&gt;说明： 此插件只实现了自动bundle，我们需要在浏览器手动刷新index.html页面来重新请求内存中的bundle.js文件以应用更新。</p>

<p>偷懒是工程师前进的一大步！我们希望dev中间件重新打包之后，浏览器能够自刷新，即能够主动再请求一次内存中的bundle.js文件，为此
<code>webpack-hot-middleware</code>热替换(以下简称hot中间件)应运而生！<br />
hot中间件做这件事的处理方式就使用到了<code>EventSource</code><a href="https://developer.mozilla.org/zh-CN/docs/Server-sent_events/EventSource" title="点我访问">(典型的发布-订阅模式)</a></p>

<ol>
<li>服务器端bundle.js重新编译完成的时候发送通知，通知浏览器刷新</li>
<li>浏览器订阅消息完成页面刷新</li>
</ol>

<p><strong>首先处理第二步</strong>-浏览器订阅服务器端消息</p>

<p>这一步在dev中间件生成bundle.js的时候就应该完成，因此在打包的时候需要将hot中间件中已经写好的浏览器端client订阅代码打包进bundle.js,
因此在<code>webpack.config</code>文件entry中，我们指定的路径就是hot中间件提供的浏览器端的订阅消息代码路径。</p>

<pre><code class="language-js">module.exports = {
  entry: ['/webpack-hot-middleware/client','app']
};
</code></pre>

<p>看<code>webpack-hot-middleware</code>源码包就知道，<code>/webpack-hot-middleware/client</code>路径就是将包里面的client.js文件(后缀名省略了)打包进bundle.js</p>

<p>在<code>plugins</code>节点添加<code>HotModuleReplacementPlugin</code>对包文件bundle.js进行热加载替换处理！</p>

<pre><code class="language-js">plugins:[new webpack.HotModuleReplacementPlugin()]
</code></pre>

<p><strong>其次处理第一步</strong>-服务器端发布bundle.js打包好的消息</p>

<pre><code class="language-js">app.use(require(&quot;webpack-hot-middleware&quot;)(compiler));
</code></pre>

<p>hot中间件直接被当做expreejs中间件使用，透过webpack api直接通过<code>EventSource</code>发送消息出去！</p>

<h3 id="webpack-hot-middleware配置与webpack-dev-middleware配置的对应">webpack-hot-middleware配置与webpack-dev-middleware配置的对应</h3>

<p>同所有的发布-订阅一样，<code>EventSource</code>发布-订阅消息也需要一个地址(称为消息总线)</p>

<pre><code class="language-js">// /webpack-hot-middleware/client.js
var options = {
  path: &quot;/__webpack_hmr&quot;,
  timeout: 20 * 1000,
  overlay: true,
  reload: false,
  log: true,
  warn: true,
  name: '',
  autoConnect: true,
  overlayStyles: {},
  overlayWarnings: false,
  ansiColors: {}
};
</code></pre>

<p>我们看到的path就是消息总线的地址，默认为<code>/_webpack_hmr</code>,根据<a href="https://www.npmjs.com/package/webpack-hot-middleware#client" title="点我访问">文档</a>描述，
这个path的配置有两种方式，一种是直接在webpack.config文件中配置url:</p>

<pre><code class="language-js">//直接配置查询字符串
module.exports = {
  entry: ['/webpack-hot-middleware/client?path=/_eventstream_path','app']
};
</code></pre>

<p>另一种是在应用compiler中间件的时候指定options参数：</p>

<pre><code class="language-js">var hotOptions={
path:'/_eventstream_path'
};
app.use(require(&quot;webpack-hot-middleware&quot;)(compiler));
</code></pre>

<blockquote>
<p>一般使用默认配置即可，倘若要自定义的话一定要保证两者一致，这样<code>EventSource</code>才能发布-订阅到同一消息总线！(path - The path which the middleware will serve the event stream on, must match the client setting)</p>
</blockquote>

<h3 id="webpack-config中使用process-env-node-env">webpack.config中使用process.env.NODE_ENV</h3>

<p>先说最佳实践吧<strong>不要在webpack.config</strong>中使用<code>process.env.NODE_ENV</code>!
在webpack的配置文件中使用是读取不到process.env.NODE_ENV的，可以通过引入<code>dotenv</code>来访问！</p>

<pre><code class="language-js">// webpack.config.js
require('dotenv').config();
let mode=process.env.NODE_ENV;
</code></pre>

<p>我们可以使用<a href="https://webpack.docschina.org/plugins/define-plugin" title="点我访问">DefinePlugin</a>为所有依赖定义这个变量。</p>

<pre><code class="language-js">new webpack.DefinePlugin({
    'process.env.NODE_ENV': JSON.stringify('production')})
</code></pre>

<p>这样任何位于 /src 的本地代码都可以关联到 process.env.NODE_ENV 环境变量。
&gt;注意，定义在插件里的自定义常量，使用了JSON.stringify(&lsquo;production&rsquo;)指定全局常量的值！为什么呢？</p>

<p>因为DefinePlugin()内部是使用这个对象来构建一个Object类型的字符串，如果直接给&rsquo;production&rsquo;的话，这个production就不是字符串了而是一个变量。</p>

<pre><code class="language-js">return 'Object({process.env.NODE_ENV:&quot;production&quot;})'
</code></pre>

<p>官方文档有注意说明：因为这个插件直接执行文本替换，给定的值必须包含字符串本身内的实际引号。
通常，有两种方式来达到这个效果，使用 &lsquo;&ldquo;production&rdquo;&rsquo;, 或者使用 JSON.stringify(&lsquo;production&rsquo;)。
为什么要转成JSON字符串标准形式我们看如下代码演示：</p>

<pre><code class="language-js">var objStr='Object({id:&quot;name&quot;})';
eval(objStr);
//下面的代码报错
var objStr='Object({id:name})';
eval(objStr);//错误
//改成
var name='pai';
var objStr='Object({id:name})';
eval(objStr);
</code></pre>

<h3 id="局部刷新">局部刷新</h3>

<p>开发React的时候深有体会，我只是改变了一个按钮组件代码，但是整个页面都自动刷新了。我们希望保存页面的状态，仅仅只是改变组件Reander的样式，
<code>react-hot-loader</code>(热加载)应运而生。
&lt;待续！&gt;</p>
                        
                    </section>

                    <footer class="right-align">
                        <p><small>Copyright &#169; Gerry</small></p>
                    </footer>

                    


                </article>
            </div>
        </div>
    </div>

    
<script src="https://gerrywp.github.io/blog/js/jquery-2.1.4.min.js"></script>


<script src="https://gerrywp.github.io/blog/js/materialize.min.js"></script>


<script src="https://gerrywp.github.io/blog/js/imagesloaded.pkgd.min.js"></script>


<script src="https://gerrywp.github.io/blog/js/masonry.pkgd.min.js"></script>


    
    <script src="https://gerrywp.github.io/blog/js/highlight.pack.js"></script>



<script src="https://gerrywp.github.io/blog/js/lightbox.min.js"></script>


<script src="https://gerrywp.github.io/blog/js/jquery.infinitescroll.min.js"></script>


<script src="https://gerrywp.github.io/blog/js/main.js"></script>


</body>

</html>





